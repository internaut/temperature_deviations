---
title: "The most ideal year"
author: "Markus Konrad"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)

theme_set(theme_minimal())
```


## Data

source: https://www.dwd.de/DE/leistungen/klimadatendeutschland/klarchivtagmonat.html

```{r}
raw_hist <- read.delim('data/produkt_klima_tag_19500101_20221231_00403.txt', sep = ';')
head(raw_hist)
```

```{r}
raw_pres <- read.delim('data/produkt_klima_tag_20221107_20240509_00403.txt', sep = ';')
head(raw_pres)
```


```{r}
meas <- bind_rows(raw_hist, raw_pres) |>
    select(date = MESS_DATUM, temp = TMK) |>
    mutate(date = as.POSIXct(strptime(date, "%Y%m%d")),
           year = as.integer(as.numeric(format(date, "%Y"))),
           day = as.integer(as.numeric(format(date, "%j")))) |>
    distinct(date, .keep_all = TRUE)
rm(raw_hist, raw_pres)
stopifnot(all(count(meas, date)$n == 1))
head(meas)
```

```{r}
ggplot(meas, aes(date, temp)) +
    geom_line() +
    geom_smooth(method = "gam")
```

```{r}
filter(meas, year >= 2018) |>
    ggplot(aes(date, temp)) +
        geom_line()
```

```{r}
filter(meas, year == 2023) |>
    ggplot(aes(date, temp)) +
        geom_line() +
        geom_smooth()
```

```{r}
ggplot(meas, aes(day, temp, color = year)) +
    geom_point(alpha = 0.25) +
    scale_color_binned(type = 'viridis')
```

```{r}
m1 <- lm(temp ~ cos(2 * pi * day/366) + sin(2 * pi * day/366), meas)
summary(m1)
```

```{r}
plot(m1)
```

```{r}
meas_fit <- cbind(meas, m1 = fitted(m1))

filter(meas_fit, year >= 2018) |>
    ggplot() +
        geom_line(aes(date, temp), alpha = 0.25) +
        geom_line(aes(date, m1), color = 'red')
```

```{r}
ggplot(meas_fit) +
    geom_line(aes(date, temp), alpha = 0.25) +
    geom_line(aes(date, m1), color = 'red')
```



```{r}
filter(meas_fit, year %in% (1950 + 0:6 * 10)) |>
    ggplot(aes(day, temp, color = year)) +
        geom_point(alpha = 0.25) +
        geom_line(aes(day, m1), color = 'red') +
        scale_color_binned(type = 'viridis')
        
```



```{r}
m2 <- lm(temp ~ year + cos(2 * pi * day/366) + sin(2 * pi * day/366), meas)
summary(m2)
```

```{r}
plot(m2)
```


```{r}
meas_fit2 <- cbind(meas, m2 = fitted(m2))

filter(meas_fit2, year >= 2018) |>
    ggplot() +
        geom_line(aes(date, temp), alpha = 0.25) +
        geom_line(aes(date, m2), color = 'red')
```

```{r}
ggplot(meas_fit2) +
    geom_line(aes(date, temp), alpha = 0.25) +
    geom_line(aes(date, m2), color = 'red')
```


```{r}
filter(meas_fit2, year %in% (1950 + 0:6 * 10)) |>
    ggplot(aes(day, temp, color = year)) +
        geom_point(alpha = 0.25) +
        geom_line(aes(day, m2, color = year)) +
        scale_color_binned(type = 'viridis')
        
```